<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Data Injector | Epoch19 Admin</title>

  <!-- PWA Manifest & Meta -->
  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" type="image/svg+xml" href="./assets/images/favicon.svg" />
  <meta name="theme-color" content="#1e293b" />

  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@800&family=Playfair+Display:ital,wght@0,600;1,600&family=Cinzel:wght@400;600;700&family=Inter:wght@300;400;500;600;700&family=Space+Grotesk:wght@400;500;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --bg-body: #0f172a;
      --bg-glass: rgba(30,41,59,0.7);
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --primary-base: #7c3aed;
      --primary-light: #a78bfa;
      --primary-gradient: linear-gradient(135deg,#8b5cf6 0%,#6d28d9 100%);
      --success: #10b981;
      --danger: #ef4444;
      --sidebar-width: 260px;
      --header-height: 70px;
      --radius: 16px;
      --font-head: 'Cinzel',serif;
      --font-body: 'Inter',sans-serif;
      --font-display: 'Space Grotesk',sans-serif;
      --font-mono: 'Space Mono',monospace;
    }
    *{margin:0;padding:0;box-sizing:border-box;outline:none;-webkit-tap-highlight-color:transparent}
    body{
      font-family:var(--font-body);
      background-color:var(--bg-body);
      background:url('./assets/images/background.png') no-repeat center center fixed;
      background-size:cover;
      color:var(--text-main);
      min-height:100vh;
      overflow-x:hidden;
      display:flex;
      flex-direction:column;
    }
    .glass-panel{background:var(--bg-glass);backdrop-filter:blur(12px) saturate(180%);border:1px solid rgba(255,255,255,0.08);border-radius:var(--radius)}
    header{
      position:fixed;top:0;left:0;width:100%;height:var(--header-height);
      background:rgba(15,23,42,0.95);backdrop-filter:blur(20px);
      border-bottom:1px solid rgba(255,255,255,0.05);
      display:flex;align-items:center;justify-content:space-between;padding:0 24px;z-index:1000;
    }
    .header-left{display:flex;align-items:center;gap:15px}
    .logo{font-family:var(--font-head);font-weight:700;color:#fff;font-size:1.5rem;text-transform:uppercase;letter-spacing:1px;text-decoration:none}
    .logo span{color:var(--primary-light);font-weight:700}
    .admin-badge{background:var(--primary-base);color:white;padding:2px 8px;border-radius:4px;font-size:.6rem;font-weight:700;text-transform:uppercase;margin-left:5px;font-family:var(--font-body)}
    .hamburger{font-size:1.4rem;cursor:pointer;color:var(--text-muted);display:none}
    .user-avatar{width:42px;height:42px;border-radius:12px;background:var(--primary-gradient);display:grid;place-items:center;font-weight:700;color:#fff;cursor:pointer}
    
    .sidebar{
      position:fixed;top:var(--header-height);left:0;width:var(--sidebar-width);
      height:calc(100vh - var(--header-height));
      background:rgba(15,23,42,0.95);border-right:1px solid rgba(255,255,255,0.05);
      padding:20px 0;overflow-y:auto;transition:transform .3s cubic-bezier(.4,0,.2,1);
      z-index:999;display:flex;flex-direction:column;backdrop-filter:blur(20px);
    }
    .nav-group{padding:0 24px;margin-bottom:20px}
    .nav-label{font-size:.7rem;text-transform:uppercase;color:var(--primary-base);font-weight:700;margin-bottom:8px}
    .nav-item{display:flex;align-items:center;padding:12px 14px;color:var(--text-muted);text-decoration:none;font-size:.9rem;border-radius:10px;margin-bottom:4px;transition:.2s}
    .nav-item:hover{color:var(--text-main);background:rgba(255,255,255,0.05);transform:translateX(5px)}
    .nav-item.active{background:linear-gradient(90deg,rgba(124,58,237,0.15) 0%,transparent 100%);color:var(--primary-light);font-weight:600;border-left:3px solid var(--primary-base)}
    .nav-item i{width:25px;text-align:center;margin-right:10px}
    
    main{
      margin-left:var(--sidebar-width);margin-top:var(--header-height);
      padding:25px;width:calc(100% - var(--sidebar-width));flex:1;
      transition:all .3s ease;max-width:1600px;
      display:grid;grid-template-columns:1fr 2fr;gap:25px;
      position: relative;
    }
    
    /* --- TABLE PANEL (DESKTOP) --- */
    .table-panel {
        background: var(--bg-glass);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: var(--radius);
        padding: 1.5rem;
        /* Desktop: Fixed to right */
        position: fixed;
        top: calc(var(--header-height) + 25px);
        right: 25px;
        width: calc(100% - var(--sidebar-width) - 450px); 
        bottom: 30px; 
        z-index: 50;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    /* --- MOBILE RESPONSIVE --- */
    @media(max-width:1024px){
      .sidebar{transform:translateX(-100%);width:280px;box-shadow:5px 0 15px rgba(0,0,0,.5)}
      .sidebar.active{transform:translateX(0)}
      .hamburger{display:block}
      
      main {
          margin-left: 0;
          width: 100%;
          padding: 15px;
          display: block; /* Standard block layout */
      }
      
      .injector-panel {
          position: static;
          margin-bottom: 25px;
          width: 100%;
      }
      
      /* --- MOBILE TABLE: STATIC (MOVES WITH SCROLL) --- */
      .table-panel {
          position: static !important; /* Not fixed, moves with page */
          width: 100% !important;
          height: 500px !important; /* Give it height */
          max-width: 100% !important;
          margin-top: 0 !important;
          z-index: 1 !important; /* Low z-index so sidebar covers it */
          top: auto !important;
          right: auto !important;
          bottom: auto !important;
      }
    }

    .panel-header{margin-bottom:1.5rem;border-bottom:1px solid rgba(255,255,255,0.05);padding-bottom:1rem;display:flex;justify-content:space-between;align-items:center}
    .panel-header h2{font-size:1.1rem;display:flex;align-items:center;gap:10px;color:var(--primary-light);margin:0;font-family:var(--font-display);font-weight:700}
    .batch-switch{display:flex;align-items:center;gap:8px;font-size:.8rem;color:var(--text-muted);cursor:pointer}
    .toggle-track{width:40px;height:22px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:20px;position:relative;transition:.3s}
    .toggle-knob{width:16px;height:16px;background:#fff;border-radius:50%;position:absolute;top:2px;left:2px;transition:.3s}
    input[type="checkbox"]:checked+.toggle-track{background:var(--primary-base);border-color:var(--primary-base)}
    input[type="checkbox"]:checked+.toggle-track .toggle-knob{transform:translateX(18px)}
    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .full-width{grid-column:1/-1}
    .form-group label{display:block;font-size:.8rem;color:var(--text-muted);margin-bottom:5px;font-weight:600}
    .form-input{width:100%;padding:12px;background:rgba(0,0,0,0.3);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:#fff;font-family:var(--font-mono);outline:none;transition:.3s;font-size:.9rem}
    .form-input:focus{border-color:var(--primary-light);box-shadow:0 0 10px rgba(124,58,237,0.2);background:rgba(255,255,255,0.03)}
    .btn-inject{width:100%;padding:14px;margin-top:1.5rem;background:var(--primary-gradient);color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;transition:.3s;display:flex;justify-content:center;align-items:center;gap:8px;font-size:1rem}
    .btn-inject:hover{transform:translateY(-2px);box-shadow:0 5px 20px rgba(124,58,237,0.3)}
    
    .table-scroll{overflow-y:auto;overflow-x:auto;flex:1;width:100%}
    table{width:100%;border-collapse:collapse;text-align:left;min-width:700px}
    thead th{position:sticky;top:0;background:rgba(15,23,42,0.95);padding:1rem;font-size:.75rem;color:var(--primary-light);border-bottom:1px solid rgba(255,255,255,0.1);text-transform:uppercase;font-weight:700;z-index:2}
    tbody tr{border-bottom:1px solid rgba(255,255,255,0.03);transition:.2s}
    tbody tr:hover{background:rgba(255,255,255,0.02)}
    td{padding:1rem;font-family:var(--font-mono);font-size:.85rem}
    .action-cell{display:flex;gap:15px;justify-content:flex-end}
    .btn-icon{cursor:pointer;font-size:1.1rem;color:var(--text-muted);transition:.2s}
    .btn-del:hover{color:var(--danger);transform:scale(1.1)}
    
    .app-footer{margin-top:auto;padding:30px 25px;background:#0f172a;border-top:1px solid rgba(255,255,255,0.05);text-align:center;color:var(--text-muted);font-size:.8rem}
  </style>
</head>
<body>
  <header>
    <div class="header-left">
      <i class="fas fa-bars hamburger" onclick="toggleSidebar()"></i>
      <a href="admin-dashboard.html" class="logo">EPOCH<span>19</span> <span class="admin-badge">ADMIN</span></a>
    </div>
    <div class="header-actions">
      <div class="user-avatar" id="header-avatar-fallback" onclick="location.href='admin-settings.html'">A</div>
    </div>
  </header>

  <nav class="sidebar" id="sidebar">
    <div class="nav-group">
      <div class="nav-label">Command Center</div>
      <a href="admin-dashboard.html" class="nav-item"><i class="fa-solid fa-gauge-high"></i> Dashboard</a>
      <a href="admin-data.html" class="nav-item active"><i class="fa-solid fa-database"></i> Data Manager</a>
    </div>
    <div class="nav-group">
      <div class="nav-label">Operations</div>
      <a href="admin-payments.html" class="nav-item"><i class="fa-solid fa-credit-card"></i> Payments</a>
      <a href="admin-resources.html" class="nav-item"><i class="fa-solid fa-bullhorn"></i> Broadcast</a>
    </div>
    <div class="nav-group">
      <div class="nav-label">System</div>
      <a href="admin-settings.html" class="nav-item"><i class="fa-solid fa-sliders"></i> Global Config</a>
      <a href="dashboard.html" class="nav-item"><i class="fa-solid fa-eye"></i> User View</a>
      <a href="#" onclick="logout()" class="nav-item" style="color:var(--danger);margin-top:10px;"><i class="fa-solid fa-power-off"></i> Logout</a>
    </div>
  </nav>
  <div class="overlay" id="overlay" onclick="closeSidebar()" style="position:fixed;inset:0;background:rgba(0,0,0,0.4);z-index:998;display:none"></div>

  <main>
    <!-- LEFT: FORM -->
    <div class="injector-panel animate__animated animate__fadeInLeft">
      <div class="panel-header">
        <h2><i class="fa-solid fa-server"></i> Data Injector</h2>
        <label class="batch-switch">
          <input type="checkbox" id="batch-mode" style="display:none" />
          <div class="toggle-track"><div class="toggle-knob"></div></div>
          Batch Mode
        </label>
      </div>

      <form id="data-form">
        <div class="form-grid">
          <div class="form-group full-width">
            <label>Date (DD/MM/YYYY)</label>
            <input type="text" class="form-input" id="inp-date" placeholder="25/12/2025" required />
          </div>
          <div class="form-group full-width">
            <label>Country</label>
            <input type="text" class="form-input" id="inp-country" placeholder="e.g. Japan" required />
          </div>
          <div class="form-group"><label>Cases</label><input type="number" class="form-input" id="inp-cases" placeholder="0" required /></div>
          <div class="form-group"><label>Deaths</label><input type="number" class="form-input" id="inp-deaths" placeholder="0" required /></div>
          <div class="form-group"><label>Recovered</label><input type="number" class="form-input" id="inp-recovered" placeholder="0" required /></div>
          <div class="form-group"><label>Mild</label><input type="number" class="form-input" id="inp-mild" placeholder="0" required /></div>
          <div class="form-group"><label>Serious</label><input type="number" class="form-input" id="inp-serious" placeholder="0" required /></div>
        </div>
        <button type="submit" class="btn-inject" id="btn-submit"><i class="fa-solid fa-plus"></i> Add Record</button>
      </form>
    </div>

    <!-- RIGHT: TABLE -->
    <div class="table-panel animate__animated animate__fadeInRight">
      <div class="panel-header" style="margin-bottom:.5rem">
        <h2><i class="fa-solid fa-list-ul"></i> Live Database</h2>
        <div style="font-size:.75rem;color:var(--text-muted)"><i class="fa-solid fa-pen-to-square"></i> Click values to edit</div>
      </div>
      <div class="table-scroll" style="flex:1; overflow-y:auto; padding-bottom:1rem;">
        <table>
          <thead>
            <tr><th>Date</th><th>Country</th><th>Cases</th><th>Deaths</th><th>Recovered</th><th>Mild</th><th>Serious</th><th>Action</th></tr>
          </thead>
          <tbody id="admin-table-body"></tbody>
        </table>
      </div>
    </div>
  </main>

  <!-- PWA INSTALL -->
  <div id="pwa-install-popup" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 400px; background: #1e293b; border: 1px solid var(--primary-base); border-radius: 20px; padding: 20px; z-index: 3000; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 15px;">
        <div style="width: 50px; height: 50px; border-radius: 12px; background: var(--primary-gradient); display: grid; place-items: center; font-size: 1.5rem; color: #fff;"><i class="fas fa-database"></i></div>
        <div><div style="font-weight:700; color:#fff; font-size:1rem;">Data Manager</div><div style="font-size:0.8rem; color:#94A3B8;">Install app for rapid entry.</div></div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button onclick="installPWA()" style="flex: 2; padding: 10px; background: var(--primary-gradient); border: none; border-radius: 10px; font-weight: 700; cursor: pointer; color: #fff;">Install</button>
        <button onclick="dismissPWA()" style="flex: 1; padding: 10px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: var(--text-muted); cursor: pointer;">Later</button>
    </div>
  </div>

  <footer class="app-footer">Epoch19 Admin System &copy; 2025</footer>

  <!-- SCRIPT -->
  <script type="module">
    import { auth, db } from './firebase-config.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import {
      collection, addDoc, query, orderBy, limit, onSnapshot, doc,
      deleteDoc, updateDoc, getDoc, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    let IS_ADMIN = false;

    window.toggleSidebar = () => {
      document.getElementById('sidebar').classList.toggle('active');
      document.getElementById('overlay').style.display = 'block';
    };
    window.closeSidebar = () => {
      document.getElementById('sidebar').classList.remove('active');
      document.getElementById('overlay').style.display = 'none';
    };
    window.logout = () => signOut(auth).then(() => window.location.href = "index.html");

    onAuthStateChanged(auth, async (user) => {
      if (!user) return window.location.href = "login.html";

      const userRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userRef);
      if (!userSnap.exists() || userSnap.data().role !== "admin") {
        window.location.href = "dashboard.html";
        return;
      }
      IS_ADMIN = true;
      const avatar = document.getElementById("header-avatar-fallback");
      avatar.innerText = (userSnap.data().fullName || "A")[0].toUpperCase();
      loadTable();
    });

    function loadTable() {
      const q = query(collection(db, "covid_data"), orderBy("createdAt", "desc"), limit(20));
      onSnapshot(q, (snapshot) => {
        const tbody = document.getElementById("admin-table-body");
        tbody.innerHTML = "";
        if (snapshot.empty) {
          tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem;color:#94A3B8;">No records found</td></tr>`;
          return;
        }
        snapshot.forEach(docSnap => {
          const d = docSnap.data();
          const id = docSnap.id;
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${d.Date}</td>
            <td>${d.Country}</td>
            <td contenteditable onblur="updateCell('${id}','Cases',this)">${d.Cases}</td>
            <td contenteditable style="color:#EF4444" onblur="updateCell('${id}','Deaths',this)">${d.Deaths}</td>
            <td contenteditable style="color:#10B981" onblur="updateCell('${id}','Recovered',this)">${d.Recovered}</td>
            <td contenteditable onblur="updateCell('${id}','Mild',this)">${d.Mild}</td>
            <td contenteditable onblur="updateCell('${id}','Serious',this)">${d.Serious}</td>
            <td class="action-cell"><i class="fa-solid fa-trash btn-icon btn-del" onclick="deleteRecord('${id}')"></i></td>`;
          tbody.appendChild(tr);
        });
      });
    }

    document.getElementById("data-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!IS_ADMIN) return;
      const btn = document.getElementById("btn-submit");
      btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> Syncing...`;
      try {
        await addDoc(collection(db, "covid_data"), {
          Date: document.getElementById("inp-date").value,
          Country: document.getElementById("inp-country").value,
          Cases: Number(document.getElementById("inp-cases").value),
          Deaths: Number(document.getElementById("inp-deaths").value),
          Recovered: Number(document.getElementById("inp-recovered").value),
          Mild: Number(document.getElementById("inp-mild").value),
          Serious: Number(document.getElementById("inp-serious").value),
          createdAt: serverTimestamp()
        });
        Swal.fire({toast:true,position:"top-end",icon:"success",title:"Record Added",timer:1500,showConfirmButton:false,background:"#0f172a",color:"#fff"});
        if(!document.getElementById("batch-mode").checked) e.target.reset();
      } catch(err) {
        const isPerm = err.code === "permission-denied";
        Swal.fire({
          icon:"error",
          title: isPerm ? "Permission Denied" : "Error",
          text: err.message,
          background:"#0f172a",
          color:"#fff"
        });
      } finally {
        btn.innerHTML = `<i class="fa-solid fa-plus"></i> Add Record`;
      }
    });

    window.updateCell = async (id, field, el) => {
      if (!IS_ADMIN) return;
      const val = Number(el.innerText);
      if(isNaN(val)) return;
      await updateDoc(doc(db,"covid_data",id),{[field]:val});
    };

    window.deleteRecord = async (id) => {
      if (!IS_ADMIN) return;
      const res = await Swal.fire({
        title:"Delete record?",
        icon:"warning",
        showCancelButton:true,
        confirmButtonColor:"#EF4444",
        background:"#0f172a",
        color:"#fff"
      });
      if(res.isConfirmed) await deleteDoc(doc(db,"covid_data",id));
    };

    /* --- PWA --- */
    let deferredPrompt;
    window.addEventListener("beforeinstallprompt", (e) => {
      e.preventDefault();
      deferredPrompt = e;
      setTimeout(() => {
        document.getElementById("pwa-install-popup").style.display = "block";
      }, 3000);
    });
    window.installPWA = async () => { if(deferredPrompt) { deferredPrompt.prompt(); const {outcome} = await deferredPrompt.userChoice; if(outcome==='accepted') document.getElementById('pwa-install-popup').style.display = 'none'; deferredPrompt=null; }};
    window.dismissPWA = () => document.getElementById('pwa-install-popup').style.display = 'none';
  </script>
</body>
</html>
